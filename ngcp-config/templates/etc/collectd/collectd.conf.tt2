
# Config file for collectd(1).
#
# Some plugins need additional configuration and are disabled by default.
# Please read collectd.conf(5) for details.
#
# You should also read /usr/share/doc/collectd/README.Debian.plugins before
# enabling any more plugins.

[% PROCESS '/usr/lib/ngcp-ngcpcfg/get_hostname'; hostname = out -%]
[% argv.host=hostname; PROCESS '/usr/lib/ngcp-ngcpcfg/get_peername'; peername = out -%]
[% argv.host=hostname; argv.role='mgmt'; PROCESS '/usr/lib/ngcp-ngcpcfg/has_role'; is_mgmt = out -%]
[% argv.host=hostname; argv.role='db'; PROCESS '/usr/lib/ngcp-ngcpcfg/has_role'; is_db = out -%]
[% argv.host=hostname; argv.role='proxy'; PROCESS '/usr/lib/ngcp-ngcpcfg/has_role'; is_proxy = out -%]
[% argv.host=hostname; argv.role='rtp'; PROCESS '/usr/lib/ngcp-ngcpcfg/has_role'; is_rtp = out -%]
[% argv.host=hostname; argv.type='ha_int'; PROCESS '/usr/lib/ngcp-ngcpcfg/get_iface'; host_ha_iface = out -%]
[% argv.host=peername; argv.type='ha_int'; PROCESS '/usr/lib/ngcp-ngcpcfg/get_iface'; peer_ha_iface = out -%]
[% argv.role='mgmt'; argv.type='ha_int'; PROCESS '/usr/lib/ngcp-ngcpcfg/get_all_ips'; mgmt_ips = out -%]
[% argv.host=hostname; argv.type='ha_int'; PROCESS '/usr/lib/ngcp-ngcpcfg/get_all_ips_for_host'; ha_ips = out -%]


#Hostname "localhost"

FQDNLookup false
#BaseDir "/var/lib/collectd"
#PluginDir "/usr/lib/collectd"
TypesDB "/usr/share/collectd/types.db" "/etc/ngcp-check-tools/collectd-types.db"
#Interval 10
#ReadThreads 5

#LoadPlugin logfile
LoadPlugin syslog

#<Plugin logfile>
#	LogLevel "info"
#	File STDOUT
#	Timestamp true
#</Plugin>

<Plugin syslog>
	LogLevel info
</Plugin>

#LoadPlugin apache
#LoadPlugin apcups
#LoadPlugin ascent
#LoadPlugin battery
LoadPlugin cpu
#LoadPlugin cpufreq
#LoadPlugin csv
LoadPlugin df
LoadPlugin disk
#LoadPlugin dns
#LoadPlugin email
#LoadPlugin entropy
#LoadPlugin exec
#LoadPlugin hddtemp
LoadPlugin interface

#LoadPlugin ipmi

#LoadPlugin iptables
#LoadPlugin ipvs
LoadPlugin irq
#LoadPlugin libvirt
LoadPlugin load
#LoadPlugin mbmon
#LoadPlugin memcached
LoadPlugin memory
#LoadPlugin multimeter
LoadPlugin mysql
#LoadPlugin netlink
LoadPlugin network
#LoadPlugin nfs
[% IF is_mgmt -%]
LoadPlugin nginx
[% END -%]
LoadPlugin ntpd
#LoadPlugin nut
<LoadPlugin perl>
    Globals true
</LoadPlugin>
#LoadPlugin ping
#LoadPlugin powerdns
LoadPlugin processes
LoadPlugin rrdtool
#LoadPlugin sensors
#LoadPlugin serial
#LoadPlugin snmp
LoadPlugin swap
#LoadPlugin tail
#LoadPlugin tcpconns
#LoadPlugin teamspeak2
#LoadPlugin unixsock
LoadPlugin users
#LoadPlugin uuid
#LoadPlugin vmem
#LoadPlugin vserver
#LoadPlugin wireless

TypesDB "/usr/share/collectd-mod-redis/types.db"
[% IF is_db || is_proxy || is_rtp -%]
LoadPlugin redis
LoadPlugin write_redis
[% END -%]

# Workaround for annoying irq warning, see MT#10825 for details
LoadPlugin match_regex
PreCacheChain "PreCache"
<Chain "PreCache">
        <Rule "no_irq_THR">
                <Match "regex">
                        Plugin "^irq$"
                        TypeInstance "^THR$"
                </Match>
                Target "stop"
        </Rule>
</Chain>
# End of workaround for annoying warning

#<Plugin apache>
#	URL "http://localhost/status?auto"
#	User "www-user"
#	Password "secret"
#	VerifyPeer false
#	VerifyHost false
#	CACert "/etc/ssl/ca.crt"
#</Plugin>

#<Plugin apcups>
#	Host "localhost"
#	Port "3551"
#</Plugin>

#<Plugin ascent>
#	URL "http://localhost/ascent/status/"
#	User "www-user"
#	Password "secret"
#	CACert "/etc/ssl/ca.crt"
#</Plugin>

#<Plugin csv>
#	DataDir "/var/lib/collectd/csv"
#	StoreRates false
#</Plugin>

#<Plugin df>
#	Device "/dev/sda1"
#	Device "192.168.0.2:/mnt/nfs"
#	MountPoint "/home"
#	FSType "ext3"
#	IgnoreSelected false
#</Plugin>

<Plugin df>
 FSType "rootfs"
 IgnoreSelected true
</Plugin>

#<Plugin disk>
#	Disk "hda"
#	Disk "/sda[23]/"
#	IgnoreSelected false
#</Plugin>

#<Plugin dns>
#	Interface "eth0"
#	IgnoreSource "192.168.0.1"
#</Plugin>

#<Plugin email>
#	SocketGroup "collectd"
#	SocketPerms "0770"
#	MaxConns 5
#</Plugin>

#<Plugin exec>
#	Exec user "/path/to/exec"
#	Exec "user:group" "/path/to/exec"
#	NotificationExec user "/path/to/exec"
#</Plugin>

#<Plugin hddtemp>
#	Host "127.0.0.1"
#	Port 7634
#	TranslateDevicename false
#</Plugin>

#<Plugin interface>
#	Interface "eth0"
#	IgnoreSelected false
#</Plugin>

#<Plugin iptables>
#	Chain "table" "chain"
#</Plugin>

#<Plugin irq>
#	Irq 7
#	Irq 8
#	Irq 9
#	IgnoreSelected true
#</Plugin>

#<Plugin libvirt>
#	Connection "xen:///"
#	RefreshInterval 60
#	Domain "name"
#	BlockDevice "name:device"
#	InterfaceDevice "name:device"
#	IgnoreSelected false
#	HostnameFormat name
#</Plugin>

#<Plugin mbmon>
#	Host "127.0.0.1"
#	Port 411
#</Plugin>

#<Plugin memcached>
#	Host "127.0.0.1"
#	Port "11211"
#</Plugin>

<Plugin mysql>
  <Database "[% hostname %]">
    Host "localhost"
    User "[% checktools.dbuser %]"
    Password "[% checktools.dbpassword %]"
    Socket "/var/run/mysqld/mysqld.sock"
    MasterStats true

  </Database>

</Plugin>

#<Plugin netlink>
#	Interface "All"
#	VerboseInterface "All"
#	QDisc "eth0" "pfifo_fast-1:0"
#	Class "ppp0" "htb-1:10"
#	Filter "ppp0" "u32-1:0"
#	IgnoreSelected false
#</Plugin>

<Plugin network>
#	Server "ff18::efc0:4a42" "25826"
#	Server "239.192.74.66" "25826"
#	Listen "ff18::efc0:4a42" "25826"
#	Listen "239.192.74.66" "25826"

#	TimeToLive "128"
	Forward false
#	CacheFlush 1800
</Plugin>

[% IF is_mgmt -%]
<Plugin nginx>
	URL "http://localhost:[% nginx.status_port %]/nginx_status"
	VerifyPeer false
	VerifyHost false
</Plugin>
[% END -%]

<Plugin ntpd>
	Host "localhost"
	Port 123
	ReverseLookups false
</Plugin>

#<Plugin nut>
#	UPS "upsname@hostname:port"
#</Plugin>

<Plugin perl>
	IncludeDir "/usr/lib/ngcp-check-tools/collectd-plugins/"
	BaseName "Collectd::Plugin"
#	EnableDebugger ""
	LoadPlugin "NGCP"
#	LoadPlugin "bar"
</Plugin>

#<Plugin ping>
#	Host "host.foo.bar"
#	Host "host.baz.qux"
#	TTL 255
#</Plugin>

#<Plugin powerdns>
#	<Server "server_name">
#		Collect "latency"
#		Collect "udp-answers" "udp-queries"
#		Socket "/var/run/pdns.controlsocket"
#	</Server>
#	<Recursor "recursor_name">
#		Collect "questions"
#		Collect "cache-hits" "cache-misses"
#		Socket "/var/run/pdns_recursor.controlsocket"
#	</Recursor>
#	LocalSocket "/opt/collectd/var/run/collectd-powerdns"
#</Plugin>

<Plugin processes>
	Process "cron"
	Process "irqbalance"
	Process "rtpengine"
	Process "mysqld"
	Process "rsyslogd"
	Process "sshd"
	Process "rate-o-mat"
	ProcessMatch "prosody" "^lua5.1 /usr/bin/prosody"
	ProcessMatch "ngcp-csc" "^perl-fcgi-pm \\[csc\\]"
	ProcessMatch "ngcp-panel" "^perl-fcgi-pm \\[NGCP::Panel\\]"
	Process "ngcp-sems"
	ProcessMatch "lb" "^/usr/sbin/kamailio -f /etc/kamailio/lb"
	ProcessMatch "proxy" "^/usr/sbin/kamailio -f /etc/kamailio/proxy"
	Process "nginx"
	# temporal fix: MT#4643
	ProcessMatch "apache2" "^/usr/sbin/apach"
	Process "asterisk"
	Process "exim4"
	Process "mediator"
	Process "redis-server"

</Plugin>

<Plugin rrdtool>
	DataDir "/var/lib/collectd/rrd"
#	CacheTimeout 120
#	CacheFlush 900
#
# The following settings are rather advanced
# and should usually not be touched:
#	StepSize 10
#	HeartBeat 20
#	RRARows 1200
#	RRATimespan 158112000
#	XFF 0.1
</Plugin>

#<Plugin sensors>
#	Sensor "it8712-isa-0290/temperature-temp1"
#	Sensor "it8712-isa-0290/fanspeed-fan3"
#	Sensor "it8712-isa-0290/voltage-in8"
#	IgnoreSelected false
#</Plugin>

# See /usr/share/doc/collectd/examples/snmp-data.conf.gz for a
# comprehensive sample configuration.
#<Plugin snmp>
#	<Data "powerplus_voltge_input">
#		Type "voltage"
#		Table false
#		Instance "input_line1"
#		Values "SNMPv2-SMI::enterprises.6050.5.4.1.1.2.1"
#	</Data>
#	<Data "hr_users">
#		Type "users"
#		Table false
#		Instance ""
#		Values "HOST-RESOURCES-MIB::hrSystemNumUsers.0"
#	</Data>
#	<Data "std_traffic">
#		Type "if_octets"
#		Table true
#		Instance "IF-MIB::ifDescr"
#		Values "IF-MIB::ifInOctets" "IF-MIB::ifOutOctets"
#	</Data>
#
#	<Host "some.switch.mydomain.org">
#		Address "192.168.0.2"
#		Version 1
#		Community "community_string"
#		Collect "std_traffic"
#		Inverval 120
#	</Host>
#	<Host "some.server.mydomain.org">
#		Address "192.168.0.42"
#		Version 2
#		Community "another_string"
#		Collect "std_traffic" "hr_users"
#	</Host>
#	<Host "some.ups.mydomain.org">
#		Address "192.168.0.3"
#		Version 1
#		Community "more_communities"
#		Collect "powerplus_voltge_input"
#		Interval 300
#	</Host>
#</Plugin>

#<Plugin "tail">
#	<File "/var/log/exim4/mainlog">
#		Instance "exim"
#		<Match>
#			Regex "S=([1-9][0-9]*)"
#			DSType "CounterAdd"
#			Type "ipt_bytes"
#			Instance "total"
#		</Match>
#		<Match>
#			Regex "\\<R=local_user\\>"
#			DSType "CounterInc"
#			Type "counter"
#			Instance "local_user"
#		</Match>
#	</File>
#</Plugin>

#<Plugin tcpconns>
#	ListeningPorts false
#	LocalPort "25"
#	RemotePort "25"
#</Plugin>

#<Plugin teamspeak2>
#	Host "127.0.0.1"
#	Port "51234"
#	Server "8767"
#</Plugin>

#<Plugin unixsock>
#	SocketFile "/var/run/collectd-unixsock"
#	SocketGroup "collectd"
#	SocketPerms "0660"
#</Plugin>

#<Plugin uuid>
#	UUIDFile "/etc/uuid"
#</Plugin>

#<Plugin vmem>
#	Verbose false
#</Plugin>

[% IF is_db || is_proxy || is_rtp -%]
<Plugin redis>
	<Node "[% hostname %]">
		Host "[% ha_ips.0 %]"
		Port "[% redis.port %]"
		Timeout 2000
	</Node>
</Plugin>
[% END -%]

Include "/etc/collectd/thresholds.conf"
